{% extends "base.html" %}
{% load partials %}
{% block content %}
{% partialdef config_page inline %}
<div id="config_content" class="flex flex-col items-center w-full h-fit gap-8">
    <h1 class="text-2xl font-semibold">{{ entrance.name }}</h1>
    <div class="flex flex-col lg:flex-row gap-4 w-full h-full justify-between">
        <div class="w-full">
            {% component "card" %}
            {% fill "content" %}
            <div class="p-4">
                <h2 class="text-xl font-semibold">Navn</h2>
                <p>{{ entrance.name }}</p>
                {% if device %}
                <h2 class="text-xl font-semibold">Device installed <i class="bi-check"></i></h2>
                <h2 class="text-xl font-semibold">API Key</h2>
                <div>
                    {% if api_key %}
                    <input
                        value="{{ api_key }}"
                        class="rounded-lg border border-solid border-gray-300 py-2 px-3 transition-all focus:border-aau-light disabled:text-gray-600 disabled:bg-gray-100 disabled:cursor-not-allowed"
                        {% if not api_key_available %}
                        disabled
                        {% endif %}
                        oninput="this.value = '{{ api_key }}'"
                    >
                    <button
                        hx-delete="{% url 'api_key' entrance.device.id %}"
                        hx-confirm="Are you sure you want to remove the API key for {{ entrance.name }}?"
                        hx-target="#config_content"
                    >
                        <i class="bi-trash"></i>
                    </button>
                    {% else %}
                    <button
                        hx-post="{% url 'api_key' entrance.device.id %}"
                        hx-target="#config_content"
                    >
                        <i class="bi-plus"></i>
                    </button>
                    {% endif %}
                </div>
                {% else %}
                <h2 class="text-xl font-semibold">No device installed <i class="bi-x"></i></h2>
                {% endif %}
            </div>
            <div
                hx-get="{% url 'latest_events' %}?entrance={{ entrance.id }}&items=3"
                hx-trigger="every 5s"
            >
                {% component "latest_events" entrance=entrance items=3 %}{% endcomponent %}
            </div>
            {% endfill %}
            {% endcomponent %}
        </div>
        {% if perms.accounts.change_user %}
        <div class="w-full flex-col gap-4 h-fit">
            {% component "card" %}
            {% fill "content" %}
            <div class="relative w-full h-full p-4">
                <img id="backgroundImage" src="{{ image.url }}">
                <canvas id="drawingCanvas" class="absolute top-4 left-4"></canvas>
            </div>
            {% endfill %}
            {% endcomponent %}
            
            {% component "card" %}
            {% fill "content" %}
            <div class="p-4">
                <h2 class="text-xl font-semibold">Øverste venstre hjørne</h2>
                <div class="flex flex-row gap-4 justify-between">
                    <div class="flex flex-col w-full">
                        <h3 class="text-m">X-koordinat (px)</h3>
                        <input
                            id="x_top"
                            name="top-left-x"
                            type="number"
                            class="w-full rounded-lg border border-solid border-gray-300 py-2 px-3 transition-all focus:border-aau-light focus:bg-white"
                            placeholder="e.g. 583"
                        >
                    </div>
                    <div class="flex flex-col w-full">
                        <h3 class="text-m">Y-koordinat (px)</h3>
                        <input
                            id="y_top"
                            name="top-left-y"
                            type="number"
                            class="w-full rounded-lg border border-solid border-gray-300 py-2 px-3 transition-all focus:border-aau-light focus:bg-white"
                            placeholder="e.g. 363"
                        >
                    </div>
                </div>
                <h2 class="text-xl font-semibold">Nedre højre hjørne</h2>
                <div class="flex flex-row gap-4 justify-between">
                    <div class="flex flex-col w-full">
                        <h3 class="text-m">X-koordinat (px)</h3>
                        <input
                            id="x_btm"
                            name="bottom-right-x"
                            type="number"
                            class="w-full rounded-lg border border-solid border-gray-300 py-2 px-3 transition-all focus:border-aau-light focus:bg-white"
                            placeholder="e.g. 281"
                        >
                    </div>
                    <div class="flex flex-col w-full">
                        <h3 class="text-m">Y-koordinat (px)</h3>
                        <input
                            id="y_btm"
                            name="bottom-right-y"
                            type="number"
                            class="w-full rounded-lg border border-solid border-gray-300 py-2 px-3 transition-all focus:border-aau-light focus:bg-white"
                            placeholder="e.g. 927"
                        >
                    </div>
                </div>
                <button
                    id="drawBtn"
                    class="w-full px-6 py-3 mt-6 mb-2 font-bold text-center text-white uppercase transition-all rounded-lg active:opacity-85 hover:scale-[102%] shadow-md bg-gradient-to-r from-aau to-aau-light"
                >
                    Send kasse
                </button>
            </div>  
            {% endfill %}
            {% endcomponent %}
        </div>
        {% endif %}
    </div>
</div>
{% endpartialdef config_page %}
{% endblock %}
{% block js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const canvas = document.getElementById("drawingCanvas");
    if (!canvas) return; // Ensures the script runs only when the canvas exists

    //drawRectangle()

    const img = document.getElementById("backgroundImage");

    const originalWidth = img.naturalWidth;
    const originalHeight = img.naturalHeight;

    const ctx = canvas.getContext("2d");



    function resizeCanvas() {
        canvas.width = img.clientWidth;
        canvas.height = img.clientHeight;
        drawRectangle();
    }

    window.addEventListener("load", resizeCanvas);
    window.addEventListener("resize", resizeCanvas);

    function remapWidth(value) {
        return (value * canvas.width) / originalWidth;
    }

    function remapHeight(value) {
        return (value * canvas.height) / originalHeight;
    }

    function drawRectangle() {
        let x_top = remapWidth(parseInt(document.getElementById("x_top").value)) || 0;
        let y_top = remapHeight(parseInt(document.getElementById("y_top").value)) || 0;
        let x_btm = remapWidth(parseInt(document.getElementById("x_btm").value)) || 0;
        let y_btm = remapHeight(parseInt(document.getElementById("y_btm").value)) || 0;

        // Ensure x_btm is never less than x_top
        if (x_btm < x_top) {
            x_btm = x_top + 1;
            //document.getElementById("x_btm").value = x_top + 1; // Update input field
        }

        if (x_btm > originalWidth) {
            document.getElementById("x_btm").value = originalWidth;
        }

        // Ensure y_btm is never less than y_top
        if (y_btm < y_top) {
            y_btm = y_top + 1;
            //document.getElementById("y_btm").value = y_top + 1; // Update input field
        }

        if (y_btm > originalHeight) {
            document.getElementById("y_btm").value = originalHeight;
        }

        const size_x = x_btm - x_top;
        const size_y = y_btm - y_top;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = "rgba(255, 0, 0, 0.5)";
        ctx.fillRect(x_top, y_top, size_x, size_y);
    }

    
    document.getElementById("x_top").addEventListener("input", drawRectangle);
    document.getElementById("y_top").addEventListener("input", drawRectangle);
    document.getElementById("x_btm").addEventListener("input", drawRectangle);
    document.getElementById("y_btm").addEventListener("input", drawRectangle);

    drawRectangle();
});
</script>
{% endblock %}
